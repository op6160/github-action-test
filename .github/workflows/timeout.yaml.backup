# timeout.yaml
name: Github Action Test

on:
  # main brancheにpushされた場合、test.yaml Workflowが実行される
  push:
    branches:
      - main

# Jobs
jobs:
  # step単位Timeout
  timeout-on-steps:
    runs-on: jeong

    steps:
      # スクリプト実行設定
      - name: Set up repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.12 
          check-latest: false  

      # Worflow Timeout設定
      - name: timeout by step option
        if: ${{ always() }}
        timeout-minutes: 1 # 分単位、最少１分
        run: python ./test_script/timeout.py

      # bashコマンドのtimeoutを利用
      - name: timeout by bash
        if: ${{ always() }}
        shell: "C:\\jeong_installs\\Git\\bin\\bash.exe {0}" # windowsで使える git bash利用
        run: timeout 30s python ./test_script/timeout.py 

      # python subprocessの実行時間制限機能を利用
      - name: timeout by python script
        if: ${{ always() }}
        run: python ./test_script/timeout_subprocess.py

  # job単位Timeout設定
  timeout-on-job: 
    runs-on: jeong
    # Job実行条件
    needs: timeout-on-steps # timeout-on-stepsが終わってから実行
    if: ${{ always() }} # timeout-on-stepsが失敗しても実行
    # timeout設定
    timeout-minutes: 1 # すべてのジョブを１分間実行

    steps:
      # 各Jobは独立的に実行され、Jobごとに環境設定をする必要がある
      - name: Set up repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.12  # 3.12バージョンを利用
          check-latest: false   # Installされている場合、InstallせずCacheされているPythonを使う

      # Timeout 動作確認
      - name: time check script - job
        run: python ./test_script/timeout.py # repositoryのtest.pyを実行